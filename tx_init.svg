<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="829px" preserveAspectRatio="none" style="width:1173px;height:829px;" version="1.1" viewBox="0 0 1173 829"
    width="1173px" zoomAndPan="magnify"><defs><filter height="300%" id="fm6o3gjnwssl9" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><ellipse cx="261" cy="20" fill="#000000" filter="url(#fm6o3gjnwssl9)" rx="10" ry="10" style="stroke: none; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fm6o3gjnwssl9)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="227" y="50"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="48" x="237" y="71.6016">启动容器</text><rect fill="#FEFECE" filter="url(#fm6o3gjnwssl9)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="209" y="104.1328"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="84" x="219" y="125.7344">Spring解析XML</text><rect fill="#FEFECE" filter="url(#fm6o3gjnwssl9)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="232" x="145" y="158.2656"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="212" x="155" y="179.8672">找到与tx对应的TxNamespaceHandler</text><rect fill="#FEFECE" filter="url(#fm6o3gjnwssl9)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="502" x="10" y="212.3984"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="482" x="20" y="234">注册与annotation-driven对应spring-tx包下面的AnnotationDrivenBeanDefinitionParser</text><rect fill="#FEFECE" filter="url(#fm6o3gjnwssl9)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="227" y="266.5313"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="48" x="237" y="288.1328">解析标签</text><rect fill="#FEFECE" filter="url(#fm6o3gjnwssl9)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="370" x="76" y="320.6641"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="350" x="86" y="342.2656">匹配标签并执行AnnotationDrivenBeanDefinitionParser#parse()</text><polygon fill="#FBFB77" filter="url(#fm6o3gjnwssl9)" points="413.5,371.5527,413.5,412.1738,891.5,412.1738,891.5,381.5527,881.5,371.5527,413.5,371.5527" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FBFB77" points="413.5,371.5527,413.5,387.8633,393.5,391.8633,413.5,395.8633,413.5,412.1738,891.5,412.1738,891.5,381.5527,881.5,371.5527,413.5,371.5527" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="881.5" x2="881.5" y1="371.5527" y2="381.5527"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="891.5" x2="881.5" y1="381.5527" y2="381.5527"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="419.5" y="389.1211">该类实现自接口BeanPostProcessor</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="457" x="419.5" y="404.4316">在Bean初始化完成之后会执行postProcessAfterInitialization()方法生成代理类</text><rect fill="#FEFECE" filter="url(#fm6o3gjnwssl9)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="265" x="128.5" y="374.7969"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="245" x="138.5" y="396.3984">注册InfrastructureAdvisorAutoProxyCreator</text><polygon fill="#FBFB77" filter="url(#fm6o3gjnwssl9)" points="458,436.585,458,461.8955,695,461.8955,695,446.585,685,436.585,458,436.585" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FBFB77" points="458,436.585,458,445.2402,438,449.2402,458,453.2402,458,461.8955,695,461.8955,695,446.585,685,436.585,458,436.585" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="685" x2="685" y1="436.585" y2="446.585"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="695" x2="685" y1="446.585" y2="446.585"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="464" y="454.1533">用于解析Bean里@Transactional注解</text><rect fill="#FEFECE" filter="url(#fm6o3gjnwssl9)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="354" x="84" y="432.1738"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="334" x="94" y="453.7754">创建AnnotationTransactionAttributeSource的BeanDefinition</text><polygon fill="#FBFB77" filter="url(#fm6o3gjnwssl9)" points="415,490.7178,415,516.0283,488,516.0283,488,500.7178,478,490.7178,415,490.7178" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FBFB77" points="415,490.7178,415,499.373,395,503.373,415,507.373,415,516.0283,488,516.0283,488,500.7178,478,490.7178,415,490.7178" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478" x2="478" y1="490.7178" y2="500.7178"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="478" y1="500.7178" y2="500.7178"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="421" y="508.2861">创建增强</text><rect fill="#FEFECE" filter="url(#fm6o3gjnwssl9)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="268" x="127" y="486.3066"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="248" x="137" y="507.9082">创建TransactionInterceptor的BeanDefinition</text><polygon fill="#FBFB77" filter="url(#fm6o3gjnwssl9)" points="483.5,530.4395,483.5,724.166,1151.5,724.166,1151.5,540.4395,1141.5,530.4395,483.5,530.4395" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FBFB77" points="483.5,530.4395,483.5,623.3027,463.5,627.3027,483.5,631.3027,483.5,724.166,1151.5,724.166,1151.5,540.4395,1141.5,530.4395,483.5,530.4395" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1141.5" x2="1141.5" y1="530.4395" y2="540.4395"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1151.5" x2="1141.5" y1="540.4395" y2="540.4395"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="489.5" y="548.0078">创建切面</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="375" x="489.5" y="563.3184">内部包含TransactionAttributeSourcePointcut(切点)的全局变量</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="489.5" y="578.6289">切点内部又保存了TransactionAttributeSource(连接点)的引用</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="647" x="489.5" y="593.9395">private final TransactionAttributeSourcePointcut pointcut = new TransactionAttributeSourcePointcut() {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="497.5" y="609.25">@Override</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="497.5" y="624.5605">protected TransactionAttributeSource getTransactionAttributeSource() {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="505.5" y="639.8711">return transactionAttributeSource;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="497.5" y="655.1816">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="489.5" y="670.4922">};</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="489.5" y="685.8027">当Spring为Bean实施增强的时候,会根据Advisor获得PointCut</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="489.5" y="701.1133">再由PointCut中的TransactionAttributeSource去解析@Transactional注解</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="489.5" y="716.4238">最后再生成代理类</text><rect fill="#FEFECE" filter="url(#fm6o3gjnwssl9)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="405" x="58.5" y="610.2363"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="385" x="68.5" y="631.8379">创建BeanFactoryTransactionAttributeSourceAdvisor的BeanDefinition</text><rect fill="#FEFECE" filter="url(#fm6o3gjnwssl9)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="212" x="155" y="744.166"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="192" x="165" y="765.7676">将连接点解析器和增强保存进切面中</text><ellipse cx="261" cy="808.2988" fill="#FFFFFF" filter="url(#fm6o3gjnwssl9)" rx="10" ry="10" style="stroke: #000000; stroke-width: 1.5;"/><line style="stroke: #000000; stroke-width: 2.5;" x1="254.8128" x2="267.1872" y1="802.1116" y2="814.486"/><line style="stroke: #000000; stroke-width: 2.5;" x1="267.1872" x2="254.8128" y1="802.1116" y2="814.486"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="261" x2="261" y1="30" y2="50"/><polygon fill="#A80036" points="257,40,261,50,265,40,261,44" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="261" x2="261" y1="84.1328" y2="104.1328"/><polygon fill="#A80036" points="257,94.1328,261,104.1328,265,94.1328,261,98.1328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="261" x2="261" y1="138.2656" y2="158.2656"/><polygon fill="#A80036" points="257,148.2656,261,158.2656,265,148.2656,261,152.2656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="261" x2="261" y1="192.3984" y2="212.3984"/><polygon fill="#A80036" points="257,202.3984,261,212.3984,265,202.3984,261,206.3984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="261" x2="261" y1="246.5313" y2="266.5313"/><polygon fill="#A80036" points="257,256.5313,261,266.5313,265,256.5313,261,260.5313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="261" x2="261" y1="300.6641" y2="320.6641"/><polygon fill="#A80036" points="257,310.6641,261,320.6641,265,310.6641,261,314.6641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="261" x2="261" y1="354.7969" y2="374.7969"/><polygon fill="#A80036" points="257,364.7969,261,374.7969,265,364.7969,261,368.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="261" x2="261" y1="408.9297" y2="432.1738"/><polygon fill="#A80036" points="257,422.1738,261,432.1738,265,422.1738,261,426.1738" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="261" x2="261" y1="466.3066" y2="486.3066"/><polygon fill="#A80036" points="257,476.3066,261,486.3066,265,476.3066,261,480.3066" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="261" x2="261" y1="520.4395" y2="610.2363"/><polygon fill="#A80036" points="257,600.2363,261,610.2363,265,600.2363,261,604.2363" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="261" x2="261" y1="644.3691" y2="744.166"/><polygon fill="#A80036" points="257,734.166,261,744.166,265,734.166,261,738.166" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="261" x2="261" y1="778.2988" y2="798.2988"/><polygon fill="#A80036" points="257,788.2988,261,798.2988,265,788.2988,261,792.2988" style="stroke: #A80036; stroke-width: 1.0;"/><!--
@startuml
start
:启动容器;
:Spring解析XML;
:找到与tx对应的TxNamespaceHandler;
:注册与annotation-driven对应spring-tx包下面的AnnotationDrivenBeanDefinitionParser;
:解析标签;
:匹配标签并执行AnnotationDrivenBeanDefinitionParser#parse();
:注册InfrastructureAdvisorAutoProxyCreator;
note right
该类实现自接口BeanPostProcessor
在Bean初始化完成之后会执行postProcessAfterInitialization()方法生成代理类
end note
:创建AnnotationTransactionAttributeSource的BeanDefinition;
note right
用于解析Bean里@Transactional注解
end note
:创建TransactionInterceptor的BeanDefinition;
note right
创建增强
end note
:创建BeanFactoryTransactionAttributeSourceAdvisor的BeanDefinition;
note right
创建切面
内部包含TransactionAttributeSourcePointcut(切点)的全局变量
切点内部又保存了TransactionAttributeSource(连接点)的引用
private final TransactionAttributeSourcePointcut pointcut = new TransactionAttributeSourcePointcut() {
  @Override
  protected TransactionAttributeSource getTransactionAttributeSource() {
    return transactionAttributeSource;
  }
};
当Spring为Bean实施增强的时候,会根据Advisor获得PointCut
再由PointCut中的TransactionAttributeSource去解析@Transactional注解
最后再生成代理类
end note
:将连接点解析器和增强保存进切面中;
end
@enduml

PlantUML version 1.2017.16(Sun Sep 03 18:53:37 CST 2017)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_121-b13
Operating System: Mac OS X
OS Version: 10.13
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg>