<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="803px" preserveAspectRatio="none" style="width:775px;height:803px;" version="1.1" viewBox="0 0 775 803"
    width="775px" zoomAndPan="magnify"><defs><filter height="300%" id="f74j7oxd02y1h" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><ellipse cx="195" cy="20" fill="#000000" filter="url(#f74j7oxd02y1h)" rx="10" ry="10" style="stroke: none; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f74j7oxd02y1h)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="161" y="50"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="48" x="171" y="71.6016">启动容器</text><rect fill="#FEFECE" filter="url(#f74j7oxd02y1h)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="143" y="104.1328"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="84" x="153" y="125.7344">Spring解析XML</text><rect fill="#FEFECE" filter="url(#f74j7oxd02y1h)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="232" x="79" y="158.2656"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="212" x="89" y="179.8672">找到与tx对应的TxNamespaceHandler</text><rect fill="#FEFECE" filter="url(#f74j7oxd02y1h)" height="48.2656" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="285" x="52.5" y="212.3984"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="217" x="62.5" y="234">注册与annotation-driven对应spring-tx</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="265" x="62.5" y="248.1328">包下面的AnnotationDrivenBeanDefinitionParser</text><rect fill="#FEFECE" filter="url(#f74j7oxd02y1h)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="161" y="280.6641"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="48" x="171" y="302.2656">解析标签</text><rect fill="#FEFECE" filter="url(#f74j7oxd02y1h)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="370" x="10" y="334.7969"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="350" x="20" y="356.3984">匹配标签并执行AnnotationDrivenBeanDefinitionParser#parse()</text><polygon fill="#FBFB77" filter="url(#f74j7oxd02y1h)" points="347.5,378.9297,347.5,434.8613,653.5,434.8613,653.5,388.9297,643.5,378.9297,347.5,378.9297" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FBFB77" points="347.5,378.9297,347.5,402.8955,327.5,406.8955,347.5,410.8955,347.5,434.8613,653.5,434.8613,653.5,388.9297,643.5,378.9297,347.5,378.9297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="643.5" x2="643.5" y1="378.9297" y2="388.9297"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="653.5" x2="643.5" y1="388.9297" y2="388.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="353.5" y="396.498">该类实现自接口BeanPostProcessor</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="353.5" y="411.8086">在Bean初始化完成之后会执行</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="353.5" y="427.1191">postProcessAfterInitialization()方法生成代理类</text><rect fill="#FEFECE" filter="url(#f74j7oxd02y1h)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="265" x="62.5" y="389.8291"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="245" x="72.5" y="411.4307">注册InfrastructureAdvisorAutoProxyCreator</text><polygon fill="#FBFB77" filter="url(#f74j7oxd02y1h)" points="345,466.3389,345,491.6494,582,491.6494,582,476.3389,572,466.3389,345,466.3389" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FBFB77" points="345,466.3389,345,474.9941,325,478.9941,345,482.9941,345,491.6494,582,491.6494,582,476.3389,572,466.3389,345,466.3389" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="572" x2="572" y1="466.3389" y2="476.3389"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="582" x2="572" y1="476.3389" y2="476.3389"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="351" y="483.9072">用于解析Bean里@Transactional注解</text><rect fill="#FEFECE" filter="url(#f74j7oxd02y1h)" height="48.2656" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="260" x="65" y="454.8613"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="240" x="75" y="476.4629">创建AnnotationTransactionAttributeSource</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="94" x="75" y="490.5957">的BeanDefinition</text><polygon fill="#FBFB77" filter="url(#f74j7oxd02y1h)" points="302,534.6045,302,559.915,375,559.915,375,544.6045,365,534.6045,302,534.6045" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FBFB77" points="302,534.6045,302,543.2598,282,547.2598,302,551.2598,302,559.915,375,559.915,375,544.6045,365,534.6045,302,534.6045" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="365" x2="365" y1="534.6045" y2="544.6045"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="375" x2="365" y1="544.6045" y2="544.6045"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="308" y="552.1729">创建增强</text><rect fill="#FEFECE" filter="url(#f74j7oxd02y1h)" height="48.2656" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="108" y="523.127"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="154" x="118" y="544.7285">创建TransactionInterceptor</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="94" x="118" y="558.8613">的BeanDefinition</text><polygon fill="#FBFB77" filter="url(#f74j7oxd02y1h)" points="370.5,581.3926,370.5,698.5664,753.5,698.5664,753.5,591.3926,743.5,581.3926,370.5,581.3926" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#FBFB77" points="370.5,581.3926,370.5,635.9795,350.5,639.9795,370.5,643.9795,370.5,698.5664,753.5,698.5664,753.5,591.3926,743.5,581.3926,370.5,581.3926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="743.5" x2="743.5" y1="581.3926" y2="591.3926"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="753.5" x2="743.5" y1="591.3926" y2="591.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="376.5" y="598.9609">创建切面</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="376.5" y="614.2715">内部包含TransactionAttributeSourcePointcut(切点)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="376.5" y="629.582">的全局变量(匿名类实例)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="376.5" y="644.8926">切点内部又保存了TransactionAttributeSource(连接点)的引用</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="376.5" y="660.2031">当Spring为Bean实施增强的时候,会根据Advisor获得PointCut</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="376.5" y="675.5137">再由PointCut中的TransactionAttributeSource</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="376.5" y="690.8242">去解析@Transactional注解最后再生成代理类</text><rect fill="#FEFECE" filter="url(#f74j7oxd02y1h)" height="48.2656" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="311" x="39.5" y="615.8467"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="291" x="49.5" y="637.4482">创建BeanFactoryTransactionAttributeSourceAdvisor</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="94" x="49.5" y="651.5811">的BeanDefinition</text><rect fill="#FEFECE" filter="url(#f74j7oxd02y1h)" height="34.1328" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="212" x="89" y="718.5664"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="192" x="99" y="740.168">将连接点解析器和增强保存进切面中</text><ellipse cx="195" cy="782.6992" fill="#FFFFFF" filter="url(#f74j7oxd02y1h)" rx="10" ry="10" style="stroke: #000000; stroke-width: 1.5;"/><line style="stroke: #000000; stroke-width: 2.5;" x1="188.8128" x2="201.1872" y1="776.512" y2="788.8864"/><line style="stroke: #000000; stroke-width: 2.5;" x1="201.1872" x2="188.8128" y1="776.512" y2="788.8864"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="195" x2="195" y1="30" y2="50"/><polygon fill="#A80036" points="191,40,195,50,199,40,195,44" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="195" x2="195" y1="84.1328" y2="104.1328"/><polygon fill="#A80036" points="191,94.1328,195,104.1328,199,94.1328,195,98.1328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="195" x2="195" y1="138.2656" y2="158.2656"/><polygon fill="#A80036" points="191,148.2656,195,158.2656,199,148.2656,195,152.2656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="195" x2="195" y1="192.3984" y2="212.3984"/><polygon fill="#A80036" points="191,202.3984,195,212.3984,199,202.3984,195,206.3984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="195" x2="195" y1="260.6641" y2="280.6641"/><polygon fill="#A80036" points="191,270.6641,195,280.6641,199,270.6641,195,274.6641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="195" x2="195" y1="314.7969" y2="334.7969"/><polygon fill="#A80036" points="191,324.7969,195,334.7969,199,324.7969,195,328.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="195" x2="195" y1="368.9297" y2="389.8291"/><polygon fill="#A80036" points="191,379.8291,195,389.8291,199,379.8291,195,383.8291" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="195" x2="195" y1="423.9619" y2="454.8613"/><polygon fill="#A80036" points="191,444.8613,195,454.8613,199,444.8613,195,448.8613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="195" x2="195" y1="503.127" y2="523.127"/><polygon fill="#A80036" points="191,513.127,195,523.127,199,513.127,195,517.127" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="195" x2="195" y1="571.3926" y2="615.8467"/><polygon fill="#A80036" points="191,605.8467,195,615.8467,199,605.8467,195,609.8467" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="195" x2="195" y1="664.1123" y2="718.5664"/><polygon fill="#A80036" points="191,708.5664,195,718.5664,199,708.5664,195,712.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="195" x2="195" y1="752.6992" y2="772.6992"/><polygon fill="#A80036" points="191,762.6992,195,772.6992,199,762.6992,195,766.6992" style="stroke: #A80036; stroke-width: 1.0;"/><!--
@startuml
start
:启动容器;
:Spring解析XML;
:找到与tx对应的TxNamespaceHandler;
:注册与annotation-driven对应spring-tx
包下面的AnnotationDrivenBeanDefinitionParser;
:解析标签;
:匹配标签并执行AnnotationDrivenBeanDefinitionParser#parse();
:注册InfrastructureAdvisorAutoProxyCreator;
note right
该类实现自接口BeanPostProcessor
在Bean初始化完成之后会执行
postProcessAfterInitialization()方法生成代理类
end note
:创建AnnotationTransactionAttributeSource
的BeanDefinition;
note right
用于解析Bean里@Transactional注解
end note
:创建TransactionInterceptor
的BeanDefinition;
note right
创建增强
end note
:创建BeanFactoryTransactionAttributeSourceAdvisor
的BeanDefinition;
note right
创建切面
内部包含TransactionAttributeSourcePointcut(切点)
的全局变量(匿名类实例)
切点内部又保存了TransactionAttributeSource(连接点)的引用
当Spring为Bean实施增强的时候,会根据Advisor获得PointCut
再由PointCut中的TransactionAttributeSource
去解析@Transactional注解最后再生成代理类
end note
:将连接点解析器和增强保存进切面中;
end
@enduml

PlantUML version 1.2017.16(Sun Sep 03 18:53:37 CST 2017)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_121-b13
Operating System: Mac OS X
OS Version: 10.13
Default Encoding: US-ASCII
Language: zh
Country: CN
--></g></svg>